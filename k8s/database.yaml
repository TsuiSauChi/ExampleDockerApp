apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-config
data:
  startup_script.sql: |
    CREATE TABLE IF NOT EXISTS Users (
        id     INTEGER     GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, 
        name   TEXT,
        age    INTEGER
    );

    INSERT INTO Users (name, age) VALUES ('James', 24);
    INSERT INTO Users (name, age) VALUES ('Potato Man', 20);

---

# StatefulSet
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgres
spec:
  selector: 
    matchLabels:
      app: postgres-pod
  serviceName: "postgres-service"
  replicas: 2
  # Use default StorageClass
  volumeClaimTemplates:
    - metadata:
        name: postgres-storage
      spec:
        accessModes: ["ReadWriteOnce"]
        resources:
          requests:
            storage: 1Gi
  template:
    metadata:
      labels:
        app: postgres-pod
        app-service: database
    spec:
      volumes:
        - name: postgres-startup-script 
          configMap:
            name: postgres-config
      containers: 
        - name: postgres
          image: postgres:latest
          env:
            - name: POSTGRES_PASSWORD
              value: "example"
          ports:
            - containerPort: 5432
              name: postgres-port
          volumeMounts:
              # Storage to persist database records
            - name: postgres-storage
              mountPath: /data
              # Mount startup script
            - name: postgres-startup-script
              mountPath: /docker-entrypoint-initdb.d
